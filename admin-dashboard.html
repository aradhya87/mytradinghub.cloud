<!DOCTYPE html>
<html lang="en" >
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin Dashboard - MyTradingHub</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f5f9ff;
      padding: 20px;
    }
    h2 {
      color: #0055ff;
      margin-bottom: 20px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 20px;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 10px;
      text-align: left;
    }
    th {
      background: #0055ff;
      color: white;
    }
    button {
      padding: 6px 10px;
      margin-right: 5px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      color: white;
    }
    .approve {
      background: #28a745;
    }
    .reject {
      background: #dc3545;
    }
    #message {
      margin-bottom: 20px;
      font-weight: bold;
    }
  </style>
</head>
<body>

<h2>Admin Dashboard - KYC Requests</h2>

<div id="message"></div>

<table id="usersTable">
  <thead>
    <tr>
      <th>Email</th>
      <th>KYC Status</th>
      <th>ID Number</th>
      <th>Actions</th>
    </tr>
  </thead>
  <tbody>
    <!-- User rows will be injected here -->
  </tbody>
</table>

<script>
  const token = localStorage.getItem("adminToken");
  const messageDiv = document.getElementById("message");
  const tbody = document.querySelector("#usersTable tbody");

  if (!token) {
    alert("No admin token found please login first");
    window.location.href = "admin-login.html";
  }

  // Fetch KYC requests
  async function fetchUsers() {
    try {
      const res = await fetch("http://localhost:5000/admin/kyc-requests", {
        headers: { Authorization: "Bearer " + token }
      });
      if (!res.ok) throw new Error("Failed to fetch users");
      const users = await res.json();
      renderUsers(users);
    } catch (err) {
      messageDiv.textContent = err.message;
    }
  }

  // Render users in table
  function renderUsers(users) {
    tbody.innerHTML = "";
    users.forEach(user => {
      const tr = document.createElement("tr");

      tr.innerHTML = `
        <td>${user.email}</td>
        <td>${user.kycStatus}</td>
        <td>${user.kycDocuments?.idNumber || "-"}</td>
        <td>
          ${user.kycStatus === "pending" ? `
            <button class="approve" data-id="${user._id}">Approve</button>
            <button class="reject" data-id="${user._id}">Reject</button>
          ` : "-"}
        </td>
      `;

      tbody.appendChild(tr);
    });

    // Attach event listeners
    document.querySelectorAll(".approve").forEach(btn => {
      btn.addEventListener("click", () => approveKyc(btn.dataset.id));
    });
    document.querySelectorAll(".reject").forEach(btn => {
      btn.addEventListener("click", () => rejectKycPrompt(btn.dataset.id));
    });
  }

  // Approve KYC
  async function approveKyc(userId) {
    try {
      const res = await fetch("http://localhost:5000/admin/kyc-approve", {
        method: "POST",
        headers: { 
          "Content-Type": "application/json",
          Authorization: "Bearer " + token
        },
        body: JSON.stringify({ userId })
      });
      if (!res.ok) throw new Error("Failed to approve KYC");
      messageDiv.textContent = "KYC approved";
      fetchUsers();
    } catch (err) {
      messageDiv.textContent = err.message;
    }
  }

  // Prompt reason and reject KYC
  function rejectKycPrompt(userId) {
    const reason = prompt("Enter rejection reason:");
    if (reason) {
      rejectKyc(userId, reason);
    }
  }

  // Reject KYC
  async function rejectKyc(userId, reason) {
    try {
      const res = await fetch("http://localhost:5000/admin/kyc-reject", {
        method: "POST",
        headers: { 
          "Content-Type": "application/json",
          Authorization: "Bearer " + token
        },
        body: JSON.stringify({ userId, reason })
      });
      if (!res.ok) throw new Error("Failed to reject KYC");
      messageDiv.textContent = "KYC rejected and email sent";
      fetchUsers();
    } catch (err) {
      messageDiv.textContent = err.message;
    }
  }

  // Initial load
  fetchUsers();
</script>

</body>
</html>
