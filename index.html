<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MyTradingHub - Forex Trading</title>
  <link rel="stylesheet" href="style.css" />

  <!-- ðŸ” Redirect GitHub Pages to Custom Domain -->
  <script>
    if (location.hostname.includes("github.io")) {
      window.location.replace("https://mytradinghub.cloud");
    }
  </script>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.4.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.4.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.4.0/firebase-firestore.js"></script>

  <!-- TradingView Chart -->
  <script src="https://s3.tradingview.com/tv.js"></script>
</head>
<body>

<div id="authSection">
  <h2>Welcome to MyTradingHub</h2>

  <div id="registerDiv">
    <h3>Register</h3>
    <input id="regEmail" type="email" placeholder="Email" />
    <input id="regPass" type="password" placeholder="Password" />
    <button onclick="register()">Register</button>
  </div>

  <div id="loginDiv">
    <h3>Login</h3>
    <input id="loginEmail" type="email" placeholder="Email" />
    <input id="loginPass" type="password" placeholder="Password" />
    <button onclick="login()">Login</button>
  </div>
</div>

<div id="dashboard" style="display:none;">
  <h2>Hello, <span id="userEmail"></span></h2>
  <button onclick="logout()">Logout</button>

  <div id="walletInfo">
    Wallet Balance: $<span id="walletBalance">0</span>
  </div>

  <div id="tradeSection">
    <h3>Place Trade</h3>
    <label for="pairSelect">Currency Pair:</label>
    <select id="pairSelect">
      <option value="EUR/USD">EUR/USD</option>
      <option value="USD/JPY">USD/JPY</option>
      <option value="GBP/USD">GBP/USD</option>
    </select>

    <div>
      <strong>Live Price:</strong> $<span id="price">Loading...</span>
    </div>

    <input type="number" id="lotSize" placeholder="Enter lots (e.g. 1)" min="0.01" step="0.01" />
    <button onclick="placeTrade()">Place Trade</button>
  </div>

  <div id="tradeHistorySection">
    <h3>Your Trades</h3>
    <ul id="tradeHistory"></ul>
  </div>

  <div id="chartSection">
    <h3>Live Trading Chart</h3>
    <div id="tradingview_chart" style="height: 400px;"></div>
  </div>
</div>

<script>
const firebaseConfig = {
  apiKey: "YOUR_FIREBASE_API_KEY",
  authDomain: "YOUR_FIREBASE_AUTH_DOMAIN",
  projectId: "YOUR_FIREBASE_PROJECT_ID",
  storageBucket: "YOUR_FIREBASE_STORAGE_BUCKET",
  messagingSenderId: "YOUR_FIREBASE_MESSAGING_SENDER_ID",
  appId: "YOUR_FIREBASE_APP_ID"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

const apiKey = "YOUR_TWELVEDATA_API_KEY"; // Replace with your TwelveData key

const pairSelect = document.getElementById("pairSelect");
const priceSpan = document.getElementById("price");
const walletBalanceSpan = document.getElementById("walletBalance");
const tradeHistoryUl = document.getElementById("tradeHistory");
const userEmailSpan = document.getElementById("userEmail");

function showDashboard(user) {
  document.getElementById("authSection").style.display = "none";
  document.getElementById("dashboard").style.display = "block";
  userEmailSpan.textContent = user.email;
  loadWallet();
  loadPrice();
  loadTradeHistory();
  loadChart();
}

auth.onAuthStateChanged(user => {
  if (user) {
    showDashboard(user);
  } else {
    document.getElementById("authSection").style.display = "block";
    document.getElementById("dashboard").style.display = "none";
  }
});

function register() {
  const email = document.getElementById("regEmail").value;
  const pass = document.getElementById("regPass").value;
  if(!email || !pass) return alert("Please enter email and password");
  auth.createUserWithEmailAndPassword(email, pass).then(cred => {
    return db.collection("wallets").doc(cred.user.uid).set({ balance: 10000 });
  }).then(() => alert("Registered! Wallet credited with $10000"))
  .catch(err => alert(err.message));
}

function login() {
  const email = document.getElementById("loginEmail").value;
  const pass = document.getElementById("loginPass").value;
  if(!email || !pass) return alert("Please enter email and password");
  auth.signInWithEmailAndPassword(email, pass).catch(err => alert(err.message));
}

function logout() {
  auth.signOut();
}

function loadWallet() {
  const user = auth.currentUser;
  if(!user) return;
  db.collection("wallets").doc(user.uid).get().then(doc => {
    if(doc.exists) walletBalanceSpan.textContent = doc.data().balance.toFixed(2);
  });
}

function loadPrice() {
  if (!pairSelect.value) return;
  fetchPrice();
  setInterval(fetchPrice, 5000);
}

function fetchPrice() {
  const symbol = pairSelect.value.replace("/", "");
  fetch(`https://api.twelvedata.com/price?symbol=${symbol}&apikey=${apiKey}`)
    .then(res => res.json())
    .then(data => {
      if(data.price) priceSpan.textContent = parseFloat(data.price).toFixed(5);
    });
}

function placeTrade() {
  const user = auth.currentUser;
  if(!user) return alert("Login first");

  const pair = pairSelect.value;
  const lot = parseFloat(document.getElementById("lotSize").value);
  const entryPrice = parseFloat(priceSpan.textContent);

  if(!lot || lot <= 0) return alert("Enter valid lot size");

  db.collection("wallets").doc(user.uid).get().then(walletDoc => {
    const balance = walletDoc.data().balance;
    const cost = lot * entryPrice;
    if(balance < cost) return alert("Not enough balance");

    db.collection("wallets").doc(user.uid).update({
      balance: balance - cost
    });

    return db.collection("trades").add({
      uid: user.uid,
      pair: pair,
      lot: lot,
      entryPrice: entryPrice,
      status: "open",
      time: new Date(),
      closePrice: null,
      profitLoss: null
    });
  }).then(() => {
    alert("Trade placed");
    loadWallet();
    loadTradeHistory();
  }).catch(err => alert(err.message));
}

function loadTradeHistory() {
  const user = auth.currentUser;
  if(!user) return;

  const symbol = pairSelect.value.replace("/", "");
  fetch(`https://api.twelvedata.com/price?symbol=${symbol}&apikey=${apiKey}`)
    .then(res => res.json())
    .then(data => {
      if(!data.price) return;

      const currentPrice = parseFloat(data.price);
      tradeHistoryUl.innerHTML = "";

      db.collection("trades").where("uid", "==", user.uid).orderBy("time", "desc").get().then(snapshot => {
        snapshot.forEach(doc => {
          const t = doc.data();
          let pnl = 0;
          if(t.status === "open") {
            pnl = (currentPrice - t.entryPrice) * t.lot;
          } else if(t.profitLoss !== null) {
            pnl = t.profitLoss;
          }

          const li = document.createElement("li");
          li.innerHTML = `
            ${t.pair} - ${t.lot} lots @ ${t.entryPrice.toFixed(5)}<br>
            ${t.status === "open" ? `Live P/L: ${pnl.toFixed(2)} USD <button onclick="closeTrade('${doc.id}', ${currentPrice})">Close Trade</button>` : `Closed at ${t.closePrice} â†’ P/L: ${pnl.toFixed(2)} USD`}
            <hr/>
          `;
          tradeHistoryUl.appendChild(li);
        });
      });
    });
}

function closeTrade(tradeId, currentPrice) {
  const user = auth.currentUser;
  if(!user) return;

  db.collection("trades").doc(tradeId).get().then(doc => {
    const trade = doc.data();
    if(trade.status === "closed") return alert("Trade already closed");

    const pnl = (currentPrice - trade.entryPrice) * trade.lot;

    db.collection("trades").doc(tradeId).update({
      status: "closed",
      closePrice: currentPrice,
      profitLoss: pnl
    });

    db.collection("wallets").doc(user.uid).get().then(walletDoc => {
      const balance = walletDoc.data().balance;
      db.collection("wallets").doc(user.uid).update({
        balance: balance + pnl
      }).then(() => {
        alert(`Trade closed with P/L: ${pnl.toFixed(2)} USD`);
        loadWallet();
        loadTradeHistory();
      });
    });
  });
}

function loadChart() {
  new TradingView.widget({
    container_id: "tradingview_chart",
    width: "100%",
    height: 400,
    symbol: "FX:" + pairSelect.value.replace("/", ""),
    interval: "1",
    timezone: "Etc/UTC",
    theme: "light",
    style: "1",
    locale: "en",
    enable_publishing: false,
    hide_legend: false,
    allow_symbol_change: true
  });
}

pairSelect.addEventListener("change", () => {
  fetchPrice();
  loadTradeHistory();
  loadChart();
});
</script>

</body>
</html>
